CREATE VIEW lucro_prejuizo AS SELECT produto.codigo, produto.nome, produto.tipo_produto, SUM(quantidade_venda * ((1 - ((COALESCE((EXTRACT(YEAR FROM AGE(data_venda, data_nascimento)) > 60)::int, 0) + COALESCE((EXTRACT(YEAR FROM AGE(data_venda, data_cadastro)) > 2)::int, 0) + COALESCE(aposentado::int, 0) + COALESCE(necessidades_especiais::int, 0)) * 0.10)) * preco_unitario_venda - preco_unitario_compra)) AS valor_total FROM compra INNER JOIN produto ON produto.codigo = compra.codigo_compra INNER JOIN venda ON produto.codigo = venda.codigo_venda INNER JOIN cliente ON venda.cliente = cliente.cpf_cnpj GROUP BY produto.codigo ORDER BY tipo_produto, valor_total DESC, produto.nome;